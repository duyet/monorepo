---
title: 'Rust: Box'
date: '2022-03-05'
author: Van-Duyet Le
category: Rust ğŸ¦€
tags:
  - Rust
  - Vietnamese
  - Rust Tiáº¿ng Viá»‡t
  - Rust Basic
slug: /2022/03/rust-box.html
thumbnail: https://i.imgur.com/Axgh2R9.png
twitterCommentUrl: https://twitter.com/search?q=https%3A%2F%2Fblog.duyet.net%2F2022%2F03%2Frust-box.html
description: Táº¥t cáº£ giÃ¡ trá»‹ trÃªn Rust máº·c Ä‘á»‹nh Ä‘á»u Ä‘Æ°á»£c allocated trÃªn stack. GiÃ¡ trá»‹ cÃ³ thá»ƒ Ä‘Æ°á»£c boxed, allocated trÃªn heap báº±ng cÃ¡ch sá»­ dá»¥ng Box<T>. Box<T> lÃ  má»™t smart pointer cá»§a Rust cho phÃ©p allocated trÃªn heap giÃ¡ trá»‹ cÃ³ kiá»ƒu T, cÃ²n pointer trá» Ä‘áº¿n giÃ¡ trá»‹ Ä‘Ã³ sáº½ náº±m trÃªn stack.
---

<div class="noti">Chuá»—i bÃ i viáº¿t <a href="/tag/rust-tiáº¿ng-viá»‡t/">Rust Tiáº¿ng Viá»‡t</a> lÃ  má»™t trong nhá»¯ng ná»™i dung náº±m trong sÃ¡ch <a href="https://rust-tieng-viet.github.io/?utm_source=blog.duyet.net&utm_medium=post&utm_campaign=launch_rust_tieng_viet" target="_blank"><strong>Rust Tiáº¿ng Viá»‡t</strong></a></div>

Táº¥t cáº£ giÃ¡ trá»‹ trÃªn Rust máº·c Ä‘á»‹nh Ä‘á»u Ä‘Æ°á»£c allocated trÃªn stack. GiÃ¡ trá»‹ cÃ³ thá»ƒ Ä‘Æ°á»£c _boxed_, allocated trÃªn heap báº±ng cÃ¡ch sá»­ dá»¥ng `Box<T>`.
`Box<T>` lÃ  má»™t smart pointer cá»§a Rust cho phÃ©p allocated trÃªn heap giÃ¡ trá»‹ cÃ³ kiá»ƒu `T`, cÃ²n pointer trá» Ä‘áº¿n giÃ¡ trá»‹ Ä‘Ã³ sáº½ náº±m trÃªn stack.
[Xem thÃªm vá» stack vÃ  heap táº¡i Ä‘Ã¢y](https://doc.rust-lang.org/book/ch04-01-what-is-ownership.html#the-stack-and-the-heap).

![Box - generated by DALLÂ·E](https://i.imgur.com/Axgh2R9.png)

Khi má»™t Box náº±m ngoÃ i scope, destructor sáº½ Ä‘Æ°á»£c gá»i Ä‘á»ƒ giáº£i phÃ³ng bá»™ nhá»›.
Sá»­ dá»¥ng Box khÃ´ng áº£nh hÆ°á»Ÿng nhiá»u Ä‘áº¿n performance do Box khÃ´ng bá»• sung thÃªm thÃ´ng tin metadata nÃ o khÃ¡c.

```rust
fn main() {
  let b = Box::new(5);
  println!("b = {}", b);
}
```

á» vÃ­ dá»¥ trÃªn, chÃºng ta Ä‘á»‹nh nghÄ©a `b` cÃ³ giÃ¡ trá»‹ cá»§a `Box` Ä‘ang trá» Ä‘áº¿n giÃ¡ trá»‹ `5` vÃ  `5` Ä‘ang Ä‘Æ°á»£c allocated trÃªn heap. ChÆ°Æ¡ng trÃ¬nh sáº½ in ra `b = 5` , cÃ¡ch truy cáº­p giá»‘ng há»‡t cÃ¡ch allocated trÃªn stack. Giá»‘ng nhÆ° owned value, khi box out of scope, cuá»‘i hÃ m `main` sáº½ Ä‘Æ°á»£c giáº£i phÃ³ng.

LÆ°u má»™t giÃ¡ trá»‹ Ä‘Æ¡n giáº£n trÃªn Box khÃ´ng mang láº¡i lá»£i Ã­ch gÃ¬ cáº£. ChÃºng ta sáº½ thÆ°á»ng dÃ¹ng Box trong cÃ¡c trÆ°á»ng há»£p sau:

1. Khi báº¡n cÃ³ má»™t type mÃ  khÃ´ng biáº¿t trÆ°á»›c size á»Ÿ compile time, vÃ  báº¡n cáº§n sá»­ dá»¥ng type Ä‘Ã³ trong má»™t sá»‘ ngá»¯ cáº£nh cáº§n biáº¿t trÆ°á»›c chÃ­nh xÃ¡c data size (vÃ­ dá»¥ nhÆ° _recursive type)_.
2. Báº¡n cáº§n xá»­ lÃ½ cÃ¡c kiá»ƒu dá»¯ liá»‡u nhÆ°ng chá»‰ muá»‘n quan tÃ¢m Ä‘áº¿n type Ä‘Ã³ Ä‘Æ°á»£c implement trait nÃ o.
3. Khi báº¡n cÃ³ má»™t lÆ°á»£ng lá»›n data cáº§n transfer ownership nhÆ°ng muá»‘n cháº¯c lÃ  data sáº½ khÃ´ng bá»‹ copy, sáº½ áº£nh hÆ°á»Ÿng Ä‘áº¿n hiá»‡u nÄƒng vÃ  lÃ m tÄƒng bá»™ nhá»›.

ChÃºng ta sáº½ lÃ m rÃµ ngay sau Ä‘Ã¢y.

# 1. Recursive types vá»›i `Box`

Táº¡i compile time, Rust cáº§n biáº¿t cáº§n pháº£i biáº¿t cáº§n bao nhiÃªu bá»™ nhá»›. Má»™t trong nhá»¯ng kiá»ƒu dá»¯ liá»‡u mÃ  Rust khÃ´ng biáº¿t trÆ°á»›c Ä‘Æ°á»£c size lÃ  _recursive type._ GiÃ¡ trá»‹ cÃ³ thá»ƒ lÃ  má»™t pháº§n cá»§a giÃ¡ trá»‹ khÃ¡c cÃ³ cÃ¹ng má»™t kiá»ƒu. Bá»Ÿi vÃ¬ nesting of values theo lÃ½ thuyáº¿t cÃ³ thá»ƒ kÃ©o dÃ i Ä‘áº¿n vÃ´ háº¡n. Trong trÆ°á»ng há»£p nÃ y ta cÃ³ thá»ƒ dÃ¹ng `Box`.

[Cons list](https://en.wikipedia.org/wiki/Cons) lÃ  má»™t kiá»ƒu dá»¯ liá»‡u phá»• biáº¿n trong cÃ¡c ngÃ´n ngá»¯ functional programming,
lÃ  má»™t vÃ­ dá»¥ cá»§a recursive type. Cons lÃ  viáº¿t táº¯t cá»§a _"construct function"_.
Má»—i item trong cons list cÃ³ 2 thÃ nh pháº§n: giÃ¡ trá»‹ cá»§a item hiá»‡n táº¡i vÃ  next item.
Item cuá»‘i cÃ¹ng cÃ³ giÃ¡ trá»‹ Nil vÃ  khÃ´ng cÃ³ next item.

```rust
enum List {
  Cons(i32, List),
  Nil,
}
```

BÃ¢y giá» hÃ£y sá»­ dá»¥ng `List` type Ä‘á»ƒ lÆ°u list `1, 2, 3` nhÆ° sau

```rust
enum List {
  Cons(i32, List),
  Nil,
}

use List::{Cons, Nil};

fn main() {
  let list = Cons(1, Cons(2, Cons(3, Nil)));
}
```

Náº¿u chÃºng ta compile Ä‘oáº¡n code trÃªn, compiler sáº½ bÃ¡o nhÆ° sau:

```rust
$ cargo run
   Compiling cons-list v0.1.0 (file:///duyet/cons-list)
error[E0072]: recursive type `List` has infinite size
 --> src/main.rs:1:1
  |
1 | enum List {
  | ^^^^^^^^^ recursive type has infinite size
2 |     Cons(i32, List),
  |               ---- recursive without indirection
  |
help: insert some indirection (e.g., a `Box`, `Rc`, or `&`) to make `List` representable
  |
2 |     Cons(i32, Box<List>),
  |               ++++    +

error[E0391]: cycle detected when computing drop-check constraints for `List`
 --> src/main.rs:1:1
  |
1 | enum List {
  | ^^^^^^^^^
  |
  = note: ...which immediately requires computing drop-check constraints for `List` again
  = note: cycle used when computing dropck types for `Canonical { max_universe: U0, variables: [], value: ParamEnvAnd { param_env: ParamEnv { caller_bounds: [], reveal: UserFacing }, value: List } }`

Some errors have detailed explanations: E0072, E0391.
For more information about an error, try `rustc --explain E0072`.
error: could not compile `cons-list` due to 2 previous errors
```

Compiler nÃ³i ráº±ng kiá»ƒu dá»¯ liá»‡u nÃ y _has infinite size._ Bá»Ÿi vÃ¬ `List` cÃ³ variant lÃ  `List::Cons` chá»©a trá»±c tiáº¿p má»™t `List` khÃ¡c trong chÃ­nh nÃ³. Do Ä‘Ã³ Rust sáº½ khÃ´ng biáº¿t Ä‘Æ°á»£c sáº½ cáº§n bao nhiÃªu bá»™ nhá»› Ä‘á»ƒ lÆ°u giÃ¡ trá»‹ cá»§a `List`.

Dá»«ng láº¡i má»™t chÃºt Ä‘á»ƒ xem Rust tÃ­nh toÃ¡n bá»™ nhá»› cá»§a má»™t kiá»ƒu dá»¯ liá»‡u bÃ¬nh thÆ°á»ng nhÆ° tháº¿ nÃ o:

```rust
enum Message {
  Quit,
  Move { x: i32, y: i32 },
  Write(String),
  ChangeColor(i32, i32, i32),
}
```

Äá»ƒ xÃ¡c Ä‘á»‹nh bao nhiÃªu bá»™ nhá»› cáº§n Ä‘á»ƒ allocate cho `Message`, Rust sáº½ kiá»ƒm tra tá»«ng variant (biáº¿n thá»ƒ cá»§a enum) Ä‘á»ƒ xem variant nÃ o cáº§n bá»™ nhá»› nhiá»u nháº¥t. Rust tháº¥y ráº±ng `Message::Quit` khÃ´ng cáº§n, `Message::Move` pháº£i cáº§n Ã­t nháº¥t bá»™ nhá»› Ä‘á»ƒ lÆ°u hai giÃ¡ trá»‹ `i32`. TÆ°Æ¡ng tá»± vá»›i cÃ¡c variant cÃ²n láº¡i. Bá»Ÿi vÃ¬ má»™t thá»i Ä‘iá»ƒm cho cÃ³ má»™t variant Ä‘Æ°á»£c sá»­ dá»¥ng, do Ä‘Ã³ bá»™ nhá»› tá»‘i Ä‘a mÃ  `Message` cáº§n sáº½ lÃ  má»™t nhá»› cáº§n Ä‘á»ƒ lÆ°u trá»¯ variant lá»›n nháº¥t.

Quay láº¡i vá»›i Cons List, bá»™ nhá»› mÃ  Rust tÃ­nh toÃ¡n Ä‘Æ°á»£c cÃ³ thá»ƒ Ä‘áº¿n vÃ´ táº­n.

![](/media/2022/03/cons.svg)

Theo nhÆ° gá»£i Ã½ cá»§a compiler, chÃºng ta cÃ³ thá»ƒ sá»­ dá»¥ng `Box<T>` Ä‘á»ƒ cÃ³ má»™t Recursive Type vá»›i má»™t kÃ­ch thÆ°á»›c bá»™ nhá»› xÃ¡c Ä‘á»‹nh:

```rust
help: insert some indirection (e.g., a `Box`, `Rc`, or `&`) to make `List` representable
  |
2 |     Cons(i32, Box<List>),
  |               ++++    +
```

Bá»Ÿi vÃ¬ `Box<T>` lÃ  má»™t pointer, Rust luÃ´n biáº¿t chÃ­nh xÃ¡c bao nhiÃªu bá»™ nhá»› mÃ  má»™t `Box<T>` **pointer** cáº§n.

![](/media/2022/03/cons-box.png)

ChÆ°Æ¡ng trÃ¬nh cá»§a chÃºng ta lÃºc nÃ y sáº½ lÃ :

```rust
enum List {
  Cons(i32, Box<List>),
  Nil,
}

use List::{Cons, Nil};

fn main() {
  let list = Cons(1, Box::new(Cons(2, Box::new(Cons(3, Box::new(Nil))))));
}
```

# 2. Sá»­ dá»¥ng _trait objects_ cho phÃ©p sá»­ dá»¥ng giÃ¡ trá»‹ tá»« nhiá»u kiá»ƒu dá»¯ liá»‡u khÃ¡c nhau

Má»™t giá»›i háº¡n cá»§a `Vec` lÃ  chá»‰ cÃ³ thá»ƒ lÆ°u trá»¯ cÃ¡c thÃ nh pháº§n cÃ³ kiá»ƒu dá»¯ liá»‡u giá»‘ng nhau mÃ  thÃ´i. Ta cÃ³ thá»ƒ lÃ¡ch luáº­t trong má»™t sá»‘ trÆ°á»ng há»£p báº±ng cÃ¡ch sá»­ dá»¥ng enum cÃ³ nhiá»u variant giá»¯ nhiá»u kiá»ƒu dá»¯ liá»‡u khÃ¡c nhau

```rust
enum Cell {
  Int(i32),
  Float(f64),
  Text(String),
}

let row = vec![
  Cell::Int(3),
  Cell::Text(String::from("blue")),
  Cell::Float(10.12),
];
```

Tuy nhiÃªn, trong má»™t sá»‘ trÆ°á»ng há»£p mong muá»‘n thÆ° viá»‡n cá»§a chÃºng ta cÃ³ thá»ƒ dá»… dÃ ng Ä‘Æ°á»£c má»Ÿ rá»™ng má»™t sá»‘ trÆ°á»ng há»£p khÃ¡c. ChÃºng ta Ä‘Ã£ biáº¿t Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a Trait cho cÃ¡c Common Behavior. Trong Rust, trait Ä‘á»‹nh nghÄ©a cÃ¡c hÃ nh vi, vÃ  cÃ¡c hÃ nh vi nÃ y cÃ³ thá»ƒ Ä‘Æ°á»£c `impl` cho struct hoáº·c enum, Ä‘á»ƒ giÃºp má»™t struct hoáº·c enum mang Ä‘áº·c tÃ­nh cÃ¡c hÃ nh vi Ä‘Ã³.

```rust
pub trait Draw {
  fn draw(&self);
}

pub struct Screen {
  pub components: Vec<Box<dyn Draw>>,
}

impl Screen {
  pub fn run(&self) {
    for component in self.components.iter() {
      component.draw();
    }
  }
}
```

HÃ£y xem vÃ­ dá»¥ trÃªn, ta cÃ³ `components` cÃ³ kiá»ƒu dá»¯ liá»‡u lÃ  `Vec<T>` vá»›i `<T>` lÃ  má»™t `Box<dyn Draw>`. ChÃºng ta Ä‘Ã£ Ä‘á»‹nh nghÄ©a má»™t vector chá»©a kiá»ƒu dá»¯ liá»‡u lÃ  má»™t _trait object_.

Má»™t _trait object_ Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a báº±ng cÃ¡ch Ä‘á»‹nh nghÄ©a pointer, vÃ­ dá»¥ nhÆ° `&dyn T` hoáº·c `Box<dyn T>` smart pointer.

Má»™t _trait object_ sáº½ trá» Ä‘áº¿n:

- má»™t instance cá»§a má»™t kiá»ƒu dá»¯ liá»‡u cÃ³ implement trait cá»§a chÃºng ta
- vÃ  má»™t báº£ng ghi look up Ä‘áº¿n cÃ¡c trait methods

lÃºc runtime.

Sá»­ dá»¥ng trait object, Rust type system sáº½ cháº¯c cháº¯n lÃ  táº¡i thá»i Ä‘iá»ƒm compile, táº¥t cáº£ cÃ¡c giÃ¡ trá»‹ sá»­ dá»¥ng táº¡i ngá»¯ cáº£nh Ä‘Ã³ Ä‘á»u pháº£i Ä‘Æ°á»£c implement trai cá»§a _trait object_ Ä‘Ã³. NÃ³i tÃ³m láº¡i, chÃºng ta sáº½ khÃ´ng cáº§n quan tÃ¢m Ä‘Ã³ lÃ  kiá»ƒu dá»¯ liá»‡u gÃ¬, chá»‰ cáº§n biáº¿t kiá»ƒu dá»¯ liá»‡u Ä‘Ã³ pháº£i Ä‘Æ°á»£c implement _trait_ chÃºng ta cáº§n lÃ  Ä‘Æ°á»£c.

LÃ½ do cáº§n sá»­ dá»¥ng pointer reference `&` hoáº·c smart pointer `Box<T>` bá»Ÿi vÃ¬ compiler khÃ´ng biáº¿t chÃ­nh xÃ¡c vá» kiá»ƒu dá»¯ liá»‡u, Rust sáº½ dÃ¹ng pointer cá»§a trait object Ä‘á»ƒ biáº¿t Ä‘Æ°á»£c method nÃ o Ä‘á»ƒ cáº§n Ä‘Æ°á»£c gá»i. Xem thÃªm vá» **[Trait Objects Perform Dynamic Dispatch](https://doc.rust-lang.org/book/ch17-02-trait-objects.html#trait-objects-perform-dynamic-dispatch).**

# References

- [Using Box<T> to Point to Data on the Heap](https://doc.rust-lang.org/book/ch15-01-box.html)
- [Box, stack and heap - Rust By Example](https://doc.rust-lang.org/rust-by-example/std/box.html#box-stack-and-heap)
- [Using Trait Objects That Allow for Values of Different Types](https://doc.rust-lang.org/book/ch17-02-trait-objects.html#using-trait-objects-that-allow-for-values-of-different-types)
- [Advanced Types - The Rust Programming Language](https://doc.rust-lang.org/book/ch19-04-advanced-types.html)
- [The Stack and the Heap](https://doc.rust-lang.org/book/ch04-01-what-is-ownership.html#the-stack-and-the-heap)
